# Imager 1.004_001

Released 16 Mar 2016

- re-work the t/200-file/400-basic.t to correctly handle failures It's custom ok() function didn't have a prototype and didn't use scalar(). This caused ok() to use the note instead of the value being tested when the method called returned an empty list. For an example of the problem caused see: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=812093 
- remove some noise from when Imager tried to work with bugs in old versions of giflib. I can't do much about the new bugs. 
- the new autolevels filter (Imager 0.99) used an integer for the sample scaling factor which caused the top output level to be too low (depending on the scaling required.) It now uses a double. [#111871](https://github.com/tonycoz/imager/issues/111871) 
- the new autolevels filter had off-by-one errors calculating the minimum and maximum luminance from the histogram. This slightly reduced the contrast of the output image. [#111871](https://github.com/tonycoz/imager/issues/111871) 
- the new autolevels filter now uses a lookup table for 8-bit images to avoid a floating point multiply for each sample. [#111871](https://github.com/tonycoz/imager/issues/111871) 
- fixed several memory leaks detected by valgrind: 
- addcolors() leaked the temporary array of colors supplied to the internal API 
- make_palette() leaked the temporary image array (not the images themselves) passed to the internal API. 
- combine()/i_combine() leaked its working row buffers 
- getcolorusage()/i_get_anonymous_color_histo() leaked the sample buffer if there were too many colors 
- getcolorcount()/i_count_colors() leaked the sample buffer if there were too many colors. 
- the nearest_color filter (undocumented until I find a use for it) leaked both temporaries passed to the API and internal buffers 
- the internal process of upgrading a paletted image to a direct color image would leak a context object reference count. 
- a write failure when writing to a GIF file could leak memory. 
- failing to write to a 1-bit/pixel ICO image could leak memory. 
- Imager no longer deliberately leaks the context object from the initial thread. This was done to ensure there was always a context object available, but the code that needed that now handles the lack correctly, 
- fixed some uninitialized memory usage detected by valgrind: 
- rotate()/i_rotate_exact()/i_rotate_exact_bg()/i_matrix_transform()/ i_matrix_transform_bg() didn't initialize a working color value if there was zero pixel coverage. 
- i_ft2_cp() didn't initialize the complete color when producing an intermediate image. This caused uninitialized value usage when logging the color.